<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>离网矿区光风储柴仿真 · V2.4_geo · 动态节油对照</title>
<style>
  :root{--fg:#111;--muted:#666;--box:#d1d5db}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif;color:var(--fg);margin:14px}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;flex-wrap:wrap;gap:12px;margin:10px 0}
  .card{border:1px solid var(--box);border-radius:10px;padding:12px;background:#fff;flex:1 1 320px}
  label{display:block;font-size:12px;margin:6px 0 3px}
  input[type=number],input[type=range],select{width:100%;padding:7px 9px;border:1px solid #cbd5e1;border-radius:8px}
  input[type=range]{height:32px;padding:0}
  .btn{padding:8px 12px;border:1px solid #111;border-radius:8px;background:#fff;cursor:pointer}
  .btn.secondary{border-color:#666;color:#333}
  .kv{font-family:ui-monospace,Menlo,Consolas,monospace}
  canvas{width:100%;height:280px;background:#fff;border:1px solid #eee;border-radius:10px}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .box{border:1px solid var(--box);border-radius:10px;padding:8px 10px;min-width:150px}
  .kpi .box b{display:block;font-size:12px;color:#374151}
  .kpi .box span{display:block;font-size:18px;margin-top:2px}
  #log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:180px;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;background:#fafafa;white-space:pre-wrap;line-height:1.35}
  .legend{position:absolute; right:14px; top:10px; background:rgba(255,255,255,0.92); border:1px solid #e5e7eb; border-radius:8px; padding:6px 8px; font-size:12px}
  .legend-row{display:flex;align-items:center;gap:6px;margin:2px 0}
  .swatch{width:16px;height:3px;background:#000}
  .dash{background:linear-gradient(90deg,#000 0 40%,transparent 40% 60%,#000 60% 100%)}
  .dash2{background:linear-gradient(90deg,#000 0 30%,transparent 30% 55%,#000 55% 100%)}
  .stack{position:relative}
  footer{margin-top:14px;padding-top:10px;border-top:1px dashed #e5e7eb;color:#6b7280;font-size:12px;display:flex;gap:14px;flex-wrap:wrap}
  footer a{color:#2563eb;text-decoration:none}
</style>
</head>
<body>
<h1>Off-Grid Mining Microgrid — 35 kV · <span class="kv">V2.4_geo</span></h1>

<!-- 全局 & 地理 -->
<div class="row">
  <div class="card">
    <b>全局</b>
    <label>仿真时长（小时）</label><input id="simHours" type="number" value="24" step="1" min="1">
    <label>步长 dt（秒）</label><input id="dt" type="number" value="0.5" step="0.1" min="0.05">
    <label>名义频率 f0（Hz）</label><input id="f0" type="number" value="60" step="1" min="40" max="65">
    <label>系统阻尼 D（pu）</label><input id="Dsys" type="number" value="2.2" step="0.1">
    <label>负荷随频 α（%/Hz）</label><input id="alphaLoad" type="number" value="2.0" step="0.1">
    <div style="margin-top:8px">
      <button class="btn" id="startBtn">▶ 开始</button>
      <button class="btn secondary" id="pauseBtn">⏸ 暂停</button>
      <button class="btn secondary" id="resetBtn">↺ 重置</button>
    </div>
  </div>

  <div class="card">
    <b>地理/日照（影响 PV & 日出/日落标记）</b>
    <label>预设</label>
    <select id="geoPreset">
      <option value="custom" selected>自定义</option>
      <option value="arctic">极寒（北极圈，φ≈70°N）</option>
      <option value="desert">沙漠（φ≈25°N）</option>
      <option value="africa">非洲热带（φ≈10°N）</option>
      <option value="andes">南美安第斯（φ≈20°S）</option>
    </select>
    <label>纬度 φ（°，北正南负）</label><input id="latDeg" type="number" value="25" step="0.5" min="-75" max="75">
    <label>年内日序（1–365）</label><input id="doy" type="number" value="172" step="1" min="1" max="365">
    <label>PV 污染/积尘（0.7–1）</label><input id="pvSoil" type="number" value="0.9" step="0.01" min="0.7" max="1">
  </div>

  <div class="card">
    <b>负载 / 可再生（设 0 即无此项）</b>
    <label>负载基线（MW）</label><input id="Pload" type="number" value="12" step="0.5" min="0">
    <label>负载波动幅度（MW）</label><input id="loadVar" type="number" value="1.2" step="0.2" min="0">
    <hr>
    <label>PV 上限（MW）</label><input id="PpvMax" type="number" value="30" step="1" min="0">
    <label>PV 日形（1–3）</label><input id="pvShape" type="number" value="1.5" step="0.1" min="1" max="3">
    <label>云影强度（0–1）</label><input id="pvCloud" type="number" value="0.35" step="0.05" min="0" max="1">
    <hr>
    <label>风电上限（MW）</label><input id="PwindMax" type="number" value="6" step="1" min="0">
    <label>平均风速（m/s）</label><input id="windMean" type="number" value="8" step="0.5" min="0">
    <label>风速波动（0–1）</label><input id="windVar" type="number" value="0.4" step="0.05" min="0" max="1">
  </div>

  <div class="card">
    <b>柴油（VF）</b>
    <label>3.3MW 初始在网台数（0–6）</label><input id="dg33n" type="number" value="3" step="1" min="0" max="6">
    <label>1.25MW 初始在网台数（0–2）</label><input id="dg12n" type="number" value="0" step="1" min="0" max="2">
    <label>有功下垂 R<sub>P</sub>（%）</label><input id="Rdg" type="number" value="4" step="0.5">
    <label>单台最低负载（pu）</label><input id="dgMinPu" type="number" value="0.35" step="0.05">
    <label>上调爬坡（MW/s）</label><input id="rampUp" type="number" value="0.2" step="0.05">
    <label>下调爬坡（MW/s）</label><input id="rampDn" type="number" value="1.0" step="0.1">
    <label>启停延时（s）</label><input id="dgDelay" type="number" value="600" step="30">
    <label>启停迟滞上/下（MW）</label><input id="dgHyst" type="number" value="1.5" step="0.1">
    <label>允许全停</label>
    <select id="allowDieselOff"><option value="false" selected>否（至少1台在线）</option><option value="true">是</option></select>
  </div>

  <div class="card">
    <b>BESS（VSG）</b>
    <label>P<sub>max</sub>（MW）</label><input id="PbMax" type="number" value="8" step="0.5" min="0">
    <label>E<sub>max</sub>（MWh）</label><input id="EbMax" type="number" value="20" step="1" min="0">
    <label>初始 SOC（%）</label><input id="soc0" type="number" value="60" step="1" min="0" max="100">
    <label>下垂 R<sub>P</sub>（%）</label><input id="Rvsg" type="number" value="3" step="0.5">
    <label>虚拟惯量 H（s）</label><input id="Hvsg" type="number" value="6.0" step="0.1">
    <label>SOC 目标 / 窗口（% / %）</label>
    <div class="row" style="gap:8px"><input id="socTarget" type="number" value="55"><input id="socBand" type="number" value="10"></div>
    <label>应急：|Δf| / 过载倍数 / 时间窗（Hz / × / s）</label>
    <div class="row" style="gap:8px"><input id="femg" type="number" value="0.2" step="0.05"><input id="overMul" type="number" value="1.4" step="0.1"><input id="overSec" type="number" value="8" step="1"></div>
  </div>

  <div class="card">
    <b>保护/限功</b>
    <label>RoCoF 限值（Hz/s）</label><input id="rocMax" type="number" value="0.9" step="0.1">
    <label>Hz–W 限功：k1(60.2–60.5)/k2(&gt;60.5)</label>
    <div class="row" style="gap:8px"><input id="kof1" type="number" value="0.5" step="0.1"><input id="kof2" type="number" value="2.0" step="0.1"></div>
    <label>OF1 阈值（Hz）/时限（s）</label>
    <div class="row" style="gap:8px"><input id="of1f" type="number" value="60.5" step="0.1"><input id="of1t" type="number" value="10" step="1"></div>
    <label>OF2 阈值（Hz）/时限（s）</label>
    <div class="row" style="gap:8px"><input id="of2f" type="number" value="61.0" step="0.1"><input id="of2t" type="number" value="0.2" step="0.1"></div>
    <label>跳闸后重合闸（s）</label><input id="reclose" type="number" value="30" step="1">
  </div>
</div>

<!-- 视窗控制 -->
<div class="row">
  <div class="card" style="flex:1 1 420px">
    <b>视窗控制（可滑动时间轴）</b>
    <label>视窗长度（小时）</label><input id="viewHours" type="number" value="4" step="0.5" min="0.5">
    <label>视窗起点（小时）</label><input id="viewStart" type="range" min="0" max="20" step="0.1" value="0">
    <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
      <label style="display:flex;align-items:center;gap:6px"><input id="followLive" type="checkbox" checked> 跟随实时</label>
      <span class="kv" id="viewLabel">[0.0, 4.0] h</span>
    </div>
  </div>
</div>

<!-- 图区 -->
<div class="row">
  <div class="card stack" style="flex:2 1 560px">
    <b>功率（MW） · 视窗</b>
    <div class="legend">
      <div class="legend-row"><div class="swatch" style="background:#E69F00"></div><span>PV</span></div>
      <div class="legend-row"><div class="swatch dash2" style="background-image:linear-gradient(90deg,#D55E00 0 30%,transparent 30% 55%,#D55E00 55% 100%)"></div><span>Wind</span></div>
      <div class="legend-row"><div class="swatch" style="background:#374151"></div><span>Load</span></div>
      <div class="legend-row"><div class="swatch" style="background:#0072B2"></div><span>Diesel</span></div>
      <div class="legend-row"><div class="swatch dash" style="background-image:linear-gradient(90deg,#009E73 0 40%,transparent 40% 60%,#009E73 60% 100%)"></div><span>BESS（+放/−充）</span></div>
      <div class="legend-row"><div class="swatch" style="background:#f59e0b;height:8px;width:8px;border-radius:50%"></div><span>日出/日落</span></div>
    </div>
    <canvas id="pPlot"></canvas>
  </div>
  <div class="card stack" style="flex:1 1 340px">
    <b>频率（Hz）/ SOC（%） · 视窗</b>
    <div class="legend">
      <div class="legend-row"><div class="swatch" style="background:#6A3D9A"></div><span>Freq</span></div>
      <div class="legend-row"><div class="swatch dash" style="background-image:linear-gradient(90deg,#009E73 0 40%,transparent 40% 60%,#009E73 60% 100%)"></div><span>SOC</span></div>
      <div class="legend-row"><div class="swatch" style="background:#9ca3af;height:2px;width:18px"></div><span>f₀=60 Hz 基线</span></div>
    </div>
    <canvas id="fPlot"></canvas>
    <div id="live" class="kv" style="margin-top:6px"></div>
  </div>
</div>

<!-- 指标 & 日志 -->
<div class="card">
  <b>指标 & 日志</b>
  <div class="kpi" id="kpiRow">
    <div class="box"><b>燃油消耗</b><span id="kpiFuel">0 L</span></div>
    <div class="box"><b>燃油对照</b><span id="kpiFuelBase">0 L</span></div>
    <div class="box"><b>燃油节省</b><span id="kpiFuelSave">0 L</span></div>
    <div class="box"><b>可再生占比</b><span id="kpiRE">0%</span></div>
    <div class="box"><b>PV 发电量</b><span id="kpiPVgen">0 MWh</span></div>
    <div class="box"><b>Wind 发电量</b><span id="kpiWDgen">0 MWh</span></div>
    <div class="box"><b>弃电（PV+风）</b><span id="kpiCurt">0 MWh</span></div>
    <div class="box"><b>N−1 校核</b><span id="kpiN1">OK</span></div>
    <div class="box"><b>最近窗口</b><span id="kpiWin">—</span></div>
  </div>
  <div id="log"></div>
</div>

<footer>
  <div>© Microgrid EMS Sim · V2.4_geo</div>
  <div>|</div>
  <div>LinkedIn：<a href="https://www.linkedin.com/in/gongtiejing" target="_blank" rel="noopener">https://www.linkedin.com/in/gongtiejing</a></div>
  <div>|</div>
  <div>GitHub：<a href="https://github.com/enxpower/mining" target="_blank" rel="noopener">https://github.com/enxpower/mining</a></div>
</footer>

<script>
(function(){
/* ────────── 工具 ────────── */
const el=id=>document.getElementById(id);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmt=(v,u)=>v.toLocaleString(undefined,{maximumFractionDigits:(Math.abs(v)<10?2:1)})+(u?(" "+u):"");
function ts(t){const h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=Math.floor(t%60);
  const pad=n=>String(n).padStart(2,'0');return `[${pad(h)}:${pad(m)}:${pad(s)}]`;}

/* ────────── 颜色 ────────── */
const COLORS={ pv:'#E69F00', wind:'#D55E00', load:'#374151', diesel:'#0072B2', bess:'#009E73', freq:'#6A3D9A' };

/* ────────── DOM ────────── */
const E={
  simHours:el('simHours'), dt:el('dt'), f0:el('f0'), Dsys:el('Dsys'), alphaLoad:el('alphaLoad'),
  geoPreset:el('geoPreset'), latDeg:el('latDeg'), doy:el('doy'), pvSoil:el('pvSoil'),
  Pload:el('Pload'), loadVar:el('loadVar'),
  PpvMax:el('PpvMax'), pvShape:el('pvShape'), pvCloud:el('pvCloud'),
  PwindMax:el('PwindMax'), windMean:el('windMean'), windVar:el('windVar'),
  dg33n:el('dg33n'), dg12n:el('dg12n'), Rdg:el('Rdg'), dgMinPu:el('dgMinPu'),
  rampUp:el('rampUp'), rampDn:el('rampDn'), dgDelay:el('dgDelay'), dgHyst:el('dgHyst'), allowDieselOff:el('allowDieselOff'),
  PbMax:el('PbMax'), EbMax:el('EbMax'), soc0:el('soc0'), Rvsg:el('Rvsg'), Hvsg:el('Hvsg'), socTarget:el('socTarget'), socBand:el('socBand'),
  femg:el('femg'), overMul:el('overMul'), overSec:el('overSec'),
  rocMax:el('rocMax'), kof1:el('kof1'), kof2:el('kof2'), of1f:el('of1f'), of1t:el('of1t'), of2f:el('of2f'), of2t:el('of2t'), reclose:el('reclose'),
  startBtn:el('startBtn'), pauseBtn:el('pauseBtn'), resetBtn:el('resetBtn'),
  pPlot:el('pPlot'), fPlot:el('fPlot'), live:el('live'),
  kpiFuel:el('kpiFuel'), kpiFuelBase:el('kpiFuelBase'), kpiFuelSave:el('kpiFuelSave'),
  kpiRE:el('kpiRE'), kpiPVgen:el('kpiPVgen'), kpiWDgen:el('kpiWDgen'),
  kpiCurt:el('kpiCurt'), kpiN1:el('kpiN1'), kpiWin:el('kpiWin'),
  viewHours:el('viewHours'), viewStart:el('viewStart'), followLive:el('followLive'), viewLabel:el('viewLabel'),
  log:el('log')
};
const PCTX=E.pPlot.getContext('2d'), FCTX=E.fPlot.getContext('2d');
function logLine(s){E.log.textContent+=s+"\n";E.log.scrollTop=E.log.scrollHeight;}

/* ────────── 状态 ────────── */
let running=false, series=[], st={};

function initState(){
  // f0 兜底，避免负频误解
  const f0_in=parseFloat(E.f0.value);
  const f0_safe=(isFinite(f0_in)&&f0_in>=40&&f0_in<=65)?f0_in:60;

  st={
    t:0, f0:f0_safe, f:f0_safe, T:+E.simHours.value*3600, Sbase:12,
    lat:+E.latDeg.value*Math.PI/180, doy:+E.doy.value|0, pvSoil:+E.pvSoil.value,
    load:{base:+E.Pload.value, var:+E.loadVar.value},
    pv:{Pmax:+E.PpvMax.value, shape:+E.pvShape.value, cloud:+E.pvCloud.value, soil:+E.pvSoil.value,
        curtWh:0, ofTrip:0, ofDelay:0, genWh:0},
    wind:{Pmax:+E.PwindMax.value, vmean:+E.windMean.value, vvar:+E.windVar.value,
          curtWh:0, ofTrip:0, ofDelay:0, stopReset:0, genWh:0},
    dg:{fleet:[], Rdg:(+E.Rdg.value)/100, minPu:+E.dgMinPu.value, delay:+E.dgDelay.value, allowOff:(E.allowDieselOff.value==='true'),
        rampUp:+E.rampUp.value, rampDn:+E.rampDn.value, hyster:+E.dgHyst.value, HperMW:0.5},
    bess:{Pmax:+E.PbMax.value, Emax:+E.EbMax.value, E:+E.EbMax.value*(+E.soc0.value/100),
          R:(+E.Rvsg.value)/100, H:+E.Hvsg.value, P:0,
          socTarget:+E.socTarget.value/100, socBand:+E.socBand.value/100,
          femg:+E.femg.value, overMul:+E.overMul.value, overSec:+E.overSec.value, emgLeft:+E.overSec.value},
    D:+E.Dsys.value, alpha:+E.alphaLoad.value/100, rocMax:+E.rocMax.value,
    kof1:+E.kof1.value, kof2:+E.kof2.value, of1f:+E.of1f.value, of1t:+E.of1t.value, of2f:+E.of2f.value, of2t:+E.of2t.value, reclose:+E.reclose.value,
    fuelL:0, fuelBaselineL:0, E_load:0, pvDir:0, windDir:0, curtWh:0, n1_ok:true,
    freezeReduce:false, freezeTimer:0
  };
  buildFleet(+E.dg33n.value, +E.dg12n.value);
  series=[]; E.log.textContent="";
  const maxStart=Math.max(0,+E.simHours.value-+E.viewHours.value);
  E.viewStart.max=String(maxStart);E.viewStart.value="0";updateViewLabel();
}

/* ────────── 预设 ────────── */
E.geoPreset.addEventListener('change', ()=>{
  const v=E.geoPreset.value;
  if(v==='arctic'){E.latDeg.value=70;E.doy.value=10;E.pvSoil.value=0.95;}
  else if(v==='desert'){E.latDeg.value=25;E.doy.value=172;E.pvSoil.value=0.88;}
  else if(v==='africa'){E.latDeg.value=10;E.doy.value=200;E.pvSoil.value=0.85;}
  else if(v==='andes'){E.latDeg.value=-20;E.doy.value=250;E.pvSoil.value=0.90;}
});

/* ────────── 天文 ────────── */
function declination(doy){return 23.44*Math.PI/180*Math.sin(2*Math.PI*(284+doy)/365);}
function sunTimes(latRad,doy){
  const δ=declination(doy),φ=latRad;const x=-Math.tan(φ)*Math.tan(δ);
  if(x<=-1)return{day:24,rise:0,set:24};if(x>=1)return{day:0,rise:12,set:12};
  const ω=Math.acos(x);const day=24*ω/Math.PI;const rise=12-day/2,set=12+day/2;return{day,rise,set};
}

/* ────────── 曲线 ────────── */
function loadPower(t,f,f0){
  const base=st.load.base;
  const cyc=0.6*st.load.var*Math.sin(2*Math.PI*t/900);
  const mech=0.4*st.load.var*Math.sin(2*Math.PI*t/120);
  const droop=(1-st.alpha*((f-f0)/f0));
  return Math.max(0,(base+cyc+mech)*droop);
}
function pvAvail(t){
  if(st.pv.Pmax<=0) return 0;
  const {rise,set}=sunTimes(st.lat,st.doy);const sr=rise*3600,ss=set*3600;
  if(t<sr||t>ss) return 0;
  const Pmax=st.pv.Pmax*st.pvSoil,s=st.pv.shape;const u=(t-sr)/Math.max(1,(ss-sr));
  const day=Math.sin(Math.PI*u)**s;
  const cloud=0.5+0.5*Math.sin(0.03*t)*0.6+0.4*Math.sin(0.011*t+1.7);
  const temp=1-0.05*Math.exp(-Math.pow((u-0.5)/0.18,2));
  const clip=v=>v>0.97?0.97+(v-0.97)*0.5:v;
  return clip(Pmax*day*Math.max(0,(1-st.pv.cloud)+st.pv.cloud*cloud)*temp);
}
function windSpeed(t){
  const m=st.wind.vmean,v=st.wind.vvar;
  const base=m*(1+0.18*Math.sin(0.008*t)+0.12*Math.sin(0.021*t+1.1));
  const gust=(Math.random()-0.5)*v*1.6;return Math.max(0,base*(1+gust));
}
function windAvail(v){
  if(st.wind.Pmax<=0) return 0;const Pmax=st.wind.Pmax;
  if(v<3) return 0;if(v<12){const pu=(v-3)/(12-3);return Pmax*pu*pu;}
  if(v<=25) return Pmax; if(st.wind.stopReset<=0){st.wind.stopReset=120;logLine(`${ts(st.t)} 风机切出`);} return 0;
}

/* ────────── 保护/限功 ────────── */
function limitREByFreq(Pavail,res,dt){
  const f=st.f;if(Pavail<=0) return 0;
  if(res.ofTrip>0){res.ofTrip-=dt;return 0;}
  if(f>=st.of2f){res.ofDelay=(res._band===2?res.ofDelay+dt:dt);res._band=2;if(res.ofDelay>=st.of2t){res.ofTrip=st.reclose;res.ofDelay=0;res._band=0;logLine(`${ts(st.t)} OF2 跳闸`);return 0;}}
  else if(f>=st.of1f){res.ofDelay=(res._band===1?res.ofDelay+dt:dt);res._band=1;if(res.ofDelay>=st.of1t){res.ofTrip=st.reclose;res.ofDelay=0;res._band=0;logLine(`${ts(st.t)} OF1 跳闸`);return 0;}}
  else {res.ofDelay=Math.max(0,res.ofDelay-2*dt);res._band=0;}
  let scale=1; if(f>60.2){ if(f<60.5) scale=Math.max(0,1-st.kof1*(f-60.0));
    else scale=Math.max(0,1-st.kof1*0.5-st.kof2*(f-60.5)); }
  return Pavail*scale;
}

/* ────────── 柴油 VF ────────── */
function buildFleet(n33,n12){
  st.dg.fleet=[];for(let i=0;i<6;i++) st.dg.fleet.push(newDG(3.3,"DG3.3",i<n33));
  for(let i=0;i<2;i++) st.dg.fleet.push(newDG(1.25,"DG1.25",i<n12));
  if(!st.dg.allowOff && st.dg.fleet.filter(x=>x.online).length===0){
    st.dg.fleet[0].online=true;st.dg.fleet[0].P=st.dg.fleet[0].cap*0.7;
  }
}
function newDG(cap,type,online){return{cap,type,online,P:online?cap*0.7:0,timer:0,starting:false,stopping:false};}

function dieselDispatch(dt,fpu,residual){
  const u=st.dg.fleet;if(st.wind.stopReset>0) st.wind.stopReset-=dt;
  let onlineCap=u.reduce((a,x)=>a+(x.online?x.cap:0),0);
  const largest=Math.max(0,...u.filter(x=>x.online).map(x=>x.cap));
  const need=Math.max(0,residual);st.n1_ok=((onlineCap-largest)>=need*0.95);
  const desiredCap=(need>0)?need/0.75:(st.dg.allowOff?0:3.3);
  const upH=st.dg.hyster,dnH=st.dg.hyster*1.3;
  if(onlineCap<desiredCap-upH){if(!startOne("DG3.3")) startOne("DG1.25");}
  else if(onlineCap-desiredCap>dnH && !st.freezeReduce && st.bess.E/st.bess.Emax>0.3){stopOne();}
  for(const x of u){
    if(x.starting){x.timer-=dt;if(x.timer<=0){x.starting=false;x.online=true;x.P=x.cap*0.65;logLine(`${ts(st.t)} 并网完成：${x.type}`);}}
    if(x.stopping){x.P=Math.max(0,x.P-st.dg.rampDn*dt*1.5);x.timer-=dt;if(x.timer<=0){x.stopping=false;x.online=false;x.P=0;logLine(`${ts(st.t)} 解列完成：${x.type}`);}}
  }
  const online=u.filter(x=>x.online);const PdgMax=online.reduce((a,x)=>a+x.cap,0);
  const droopAdj=-fpu/Math.max(0.001,st.dg.Rdg)*PdgMax;
  let Pd_ref=clamp(need+droopAdj,0,PdgMax);
  const sumMin=online.reduce((a,x)=>a+x.cap*st.dg.minPu,0);
  if(Pd_ref<sumMin) Pd_ref=sumMin;
  if(st.f-st.f0>0.2) Pd_ref=Math.min(Pd_ref,sumMin+0.2*(PdgMax-sumMin));
  const per=(online.length>0)?Pd_ref/online.length:0;
  for(const x of online){const minP=x.cap*st.dg.minPu;const target=clamp(per,minP,x.cap);
    const ramp=(target<x.P)?st.dg.rampDn:st.dg.rampUp;const dP=clamp(target-x.P,-ramp*dt,ramp*dt);x.P=clamp(x.P+dP,0,x.cap);}
  return online.reduce((a,x)=>a+x.P,0);

  function startOne(type){const c=u.find(x=>!x.online && !x.starting && x.type===type);
    if(c){c.starting=true;c.timer=st.dg.delay;logLine(`${ts(st.t)} 启动命令：${type}`);return true;} return false;}
  function stopOne(){const c=u.find(x=>x.online && !x.stopping && !x.starting && x.P<x.cap*0.6);
    if(c){c.stopping=true;c.timer=st.dg.delay;logLine(`${ts(st.t)} 解列命令：${c.type}`);return true;} return false;}
}

/* 燃油（真实） */
function sfc_g_per_kWh(pu){
  if(pu<=0) return 0;
  if(pu<=0.25) return 350*pu/0.25;
  if(pu<=0.5)  return 300-(300-230)*((pu-0.25)/0.25);
  if(pu<=0.75) return 230-(230-205)*((pu-0.5)/0.25);
  return 205-(205-200)*((pu-0.75)/0.25);
}
function fuelLH(fleet){
  const rho=0.84;let Lh=0;
  for(const x of fleet){if(!x.online||x.P<=0) continue; const pu=clamp(x.P/x.cap,0,1);
    const kW=x.P*1000;const kgph=(sfc_g_per_kWh(pu)/1000)*kW;Lh+=kgph/rho;}
  return Lh; // L/h
}

/* —— 动态节油对照：全柴油最优近似 —— */
function baselineFuelLitersPerHour(Pload){
  // 用与现场一致的机组规格，但忽略爬坡/启停延时；
  // 以“尽量接近 0.65~0.75 pu”的均匀负载分配近似最省油。
  const units=[];
  for(let i=0;i<6;i++) units.push({cap:3.3});
  for(let i=0;i<2;i++) units.push({cap:1.25});
  const minPu=st.dg.minPu;

  if(Pload<=0) return 0;

  // 按容量从大到小，逐步加入，直至满足 Pload 且单机负载率落在[0.35,0.9]
  units.sort((a,b)=>b.cap-a.cap);
  let chosen=[];
  let sumCap=0;
  const targetPu=0.7;

  for(const u of units){
    chosen.push({cap:u.cap,P:0});
    sumCap+=u.cap;
    let per= Pload/Math.max(sumCap,1e-6);
    if(sumCap>=Pload && per<=0.9) break;
  }

  // 若仍不足，则全部用上
  if(sumCap<Pload){ /* 所有机组都上 */ }

  // 均匀分配并满足最低负载
  const n=chosen.length;
  let per=Math.max(Pload/sumCap, minPu);
  per=Math.min(per, 0.95);
  // 尽量靠近 targetPu
  per = clamp(Math.max(per, targetPu-0.1), minPu, 0.95);

  let Lh=0, rho=0.84;
  for(const x of chosen){
    const P = per*x.cap;
    const pu = per;
    const kW = P*1000;
    const kgph=(sfc_g_per_kWh(pu)/1000)*kW;
    Lh += kgph/rho;
  }
  // 如果 Pload 比 sumCap*per 大（极端情况），把超额按最高 SFC 估算
  const supplied = chosen.reduce((a,x)=>a+per*x.cap,0);
  if(Pload>supplied){
    const extraKW=(Pload-supplied)*1000;
    const kgph=(200/1000)*extraKW; // 200 g/kWh 粗略
    Lh += kgph/rho;
  }
  return Lh; // L/h
}

/* ────────── BESS ────────── */
function bessControl(dt,fpu,Pinj_pre){
  if(st.bess.Pmax<=0 || st.bess.Emax<=0){st.bess.P=0;return;}
  const Pmax=st.bess.Pmax;let PmaxEff=Pmax;const soc=st.bess.E/st.bess.Emax;
  if(Math.abs(st.f-st.f0)>st.bess.femg && soc<0.9 && st.bess.emgLeft>0){PmaxEff=Pmax*st.bess.overMul;}
  const P_droop=clamp(-fpu/Math.max(0.001,st.bess.R)*PmaxEff,-PmaxEff,PmaxEff);
  const P_corr=clamp(-Pinj_pre,-PmaxEff,PmaxEff);
  const err=(st.bess.socTarget - soc);const P_energy=clamp(err*Pmax*0.25,-0.6*PmaxEff,0.6*PmaxEff);
  let Pcmd=0.55*P_corr+0.35*P_droop+0.10*P_energy;
  const soft=0.08;if(soc<soft) Pcmd=Math.min(Pcmd,0);if(soc>1-soft) Pcmd=Math.max(Pcmd,0);
  st.bess.P=clamp(Pcmd,-PmaxEff,PmaxEff);
  if(PmaxEff>Pmax && Math.abs(st.bess.P)>Pmax){st.bess.emgLeft=Math.max(0,st.bess.emgLeft-dt);
    if(st.bess.emgLeft===0) logLine(`${ts(st.t)} BESS 应急时间用尽`);
  }else{st.bess.emgLeft=Math.min(st.bess.overSec, st.bess.emgLeft+0.3*dt);}
}

/* ────────── step ────────── */
function step(){
  const dt=+E.dt.value;
  const Ppv_av=pvAvail(st.t);
  const vwind=windSpeed(st.t);
  const Pwind_av=(st.wind.stopReset>0)?0:windAvail(vwind);
  const Pload=loadPower(st.t,st.f,st.f0);

  const Ppv=limitREByFreq(Ppv_av,st.pv,dt);
  const Pwind=limitREByFreq(Pwind_av,st.wind,dt);
  st.pv.genWh   += Ppv   * dt/3600;
  st.wind.genWh += Pwind * dt/3600;

  const residual=Math.max(0,Pload-(Ppv+Pwind));
  const fpu=(st.f-st.f0)/st.f0;

  const onlineCap=st.dg.fleet.reduce((a,x)=>a+(x.online?x.cap:0),0);
  st.Sbase=Math.max(12,Pload,onlineCap);

  const Pdg=dieselDispatch(dt,fpu,residual);
  const Pinj_pre=(Pdg+Ppv+Pwind)-Pload;
  bessControl(dt,fpu,Pinj_pre);

  const Hdiesel=onlineCap*st.dg.HperMW;
  const Hsys=Math.max(0.5,Hdiesel+st.bess.H);
  const Pinj=(Pdg+Ppv+Pwind+st.bess.P)-Pload;
  const Pdamp=-st.alpha*fpu*st.Sbase;
  const dpu=(Pinj+Pdamp)/st.Sbase;
  let dfdt=st.f0*(dpu - st.D*fpu)/(2*Hsys);
  dfdt=clamp(dfdt,-st.rocMax,st.rocMax);
  st.f+=dfdt*dt;

  // 能量去向
  let remain=Pload, pv2L=Math.min(Ppv,remain); remain-=pv2L;
  let wind2L=Math.min(Pwind,remain); remain-=wind2L;
  const Pb=st.bess.P;
  const chargeCap=Math.max(0,-Pb);
  const surplus=Math.max(0,(Ppv-pv2L)+(Pwind-wind2L));
  const toBess=Math.min(chargeCap,surplus);
  const curt=surplus-toBess;
  st.pv.curtWh   += curt * (Ppv/(Ppv+Pwind+1e-9)) * dt/3600;
  st.wind.curtWh += curt * (Pwind/(Ppv+Pwind+1e-9)) * dt/3600;
  st.curtWh=st.pv.curtWh+st.wind.curtWh;

  if(st.bess.Emax>0) st.bess.E=clamp(st.bess.E - st.bess.P*dt/3600,0,st.bess.Emax);
  st.E_load += Pload*dt/3600;
  st.fuelL  += fuelLH(st.dg.fleet)*dt/3600;

  // 对照：全柴油最优近似的 L/h
  const Lh_base = baselineFuelLitersPerHour(Pload);
  st.fuelBaselineL += Lh_base * dt/3600;

  if(Math.abs(st.f-st.f0)>0.5){ if(!st.freezeReduce){st.freezeReduce=true;st.freezeTimer=300;logLine(`${ts(st.t)} 频率越限，冻结减机 5min`);} }
  if(st.freezeTimer>0){st.freezeTimer-=dt;if(st.freezeTimer<=0) st.freezeReduce=false;}

  series.push({t:st.t,Ppv,Pwind,Pload,Pdg,Pb:st.bess.P,f:st.f,soc:100*(st.bess.Emax>0?st.bess.E/st.bess.Emax:0)});
  st.t+=dt;
}

/* ────────── 绘图 ────────── */
function currentWindow(){
  const Hwin=Math.min(+E.viewHours.value,+E.simHours.value);
  let Hstart=+E.viewStart.value; const Hsim=+E.simHours.value;
  if(E.followLive.checked){const tH=st.t/3600; Hstart=clamp(tH-Hwin,0,Math.max(0,Hsim-Hwin)); E.viewStart.value=String(Hstart);}
  E.viewStart.max=String(Math.max(0,Hsim-Hwin));
  return {t0:Hstart*3600,t1:(Hstart+Hwin)*3600,Hwin,Hstart};
}
function updateViewLabel(){
  const Hwin=+E.viewHours.value,Hstart=+E.viewStart.value;
  el('viewLabel').textContent=`[${Hstart.toFixed(1)}, ${(Hstart+Hwin).toFixed(1)}] h`;
}
function drawSeries(ctx,w,h,xs,ys,color,dashed=false,width=2.5){
  ctx.beginPath(); if(dashed) ctx.setLineDash([6,6]); else ctx.setLineDash([]);
  for(let i=0;i<xs.length;i++){ if(i===0) ctx.moveTo(xs[i],ys[i]); else ctx.lineTo(xs[i],ys[i]); }
  ctx.strokeStyle=color; ctx.lineWidth=width; ctx.stroke(); ctx.setLineDash([]);
}
function drawSunMarkers(ctx,w,h,t0,t1){
  const {rise,set}=sunTimes(st.lat,st.doy); const sr=rise*3600, ss=set*3600;
  const sx=t=>40+((t-t0)/(t1-t0))*(w-60);
  ctx.fillStyle='#f59e0b';
  [sr,ss].forEach(t=>{
    if(t>=t0&&t<=t1){const x=sx(t);ctx.beginPath();ctx.arc(x,18,4,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#92400e'; ctx.font=`${10*(window.devicePixelRatio||1)}px sans-serif`; ctx.fillText(`${(t/3600).toFixed(1)}h`,x-12,30); ctx.fillStyle='#f59e0b';}
  });
}
function plotPower(){
  const DPR=window.devicePixelRatio||1;
  const w=E.pPlot.width=Math.floor(E.pPlot.clientWidth*DPR);
  const h=E.pPlot.height=Math.floor(E.pPlot.clientHeight*DPR);
  const ctx=PCTX; ctx.clearRect(0,0,w,h); if(series.length<2) return;
  const {t0,t1,Hwin}=currentWindow(); const seg=series.filter(d=>d.t>=t0&&d.t<=t1); if(seg.length<2) return;
  const xs=seg.map(d=>((d.t-t0)/(t1-t0))*(w-60)+40);
  const allP=seg.flatMap(d=>[d.Ppv,d.Pwind,d.Pload,d.Pdg,d.Pb]);
  const pmin=Math.min(0,...allP), pmax=Math.max(...allP,1);
  const y=v=>(1-(v-pmin)/(pmax-pmin||1))*(h-36)+18;
  ctx.strokeStyle='#f3f4f6'; ctx.lineWidth=1;
  for(let i=0;i<5;i++){const yy=(i/4)*(h-36)+18; ctx.beginPath(); ctx.moveTo(40,yy); ctx.lineTo(w-12,yy); ctx.stroke();}
  const y0=y(0); ctx.beginPath(); ctx.moveTo(40,y0); ctx.lineTo(w-12,y0); ctx.setLineDash([5,5]); ctx.strokeStyle='#9ca3af'; ctx.lineWidth=1.2; ctx.stroke(); ctx.setLineDash([]);
  const segMap=k=>seg.map(d=>y(d[k]));
  drawSeries(ctx,w,h,xs,segMap('Ppv'),COLORS.pv);
  drawSeries(ctx,w,h,xs,segMap('Pwind'),COLORS.wind,true);
  drawSeries(ctx,w,h,xs,segMap('Pload'),COLORS.load);
  drawSeries(ctx,w,h,xs,segMap('Pdg'),COLORS.diesel);
  drawSeries(ctx,w,h,xs,segMap('Pb'),COLORS.bess);
  drawSunMarkers(ctx,w,h,t0,t1);
  ctx.fillStyle='#374151'; ctx.font=`${11*DPR}px sans-serif`; const ticks=Math.max(3,Math.round(Hwin));
  for(let k=0;k<=ticks;k++){const tk=t0+(k/ticks)*(t1-t0),x=40+(k/ticks)*(w-60);ctx.fillText(`${(tk/3600).toFixed(1)}h`,x-14,h-6);}
}
function plotFreq(){
  const DPR=window.devicePixelRatio||1;
  const w=E.fPlot.width=Math.floor(E.fPlot.clientWidth*DPR);
  const h=E.fPlot.height=Math.floor(E.fPlot.clientHeight*DPR);
  const ctx=FCTX; ctx.clearRect(0,0,w,h); if(series.length<2) return;
  const {t0,t1,Hwin}=currentWindow(); const seg=series.filter(d=>d.t>=t0&&d.t<=t1); if(seg.length<2) return;
  const xs=seg.map(d=>((d.t-t0)/(t1-t0))*(w-60)+40);
  const fVals=seg.map(d=>d.f), sVals=seg.map(d=>d.soc); const f0=st.f0;
  let fmin=Math.min(...fVals,f0-0.8), fmax=Math.max(...fVals,f0+0.8);
  if(!isFinite(fmin)||!isFinite(fmax)||fmax-fmin<0.1){ fmin=f0-0.8; fmax=f0+0.8; }
  const yF=v=>(1-(v-fmin)/(fmax-fmin||1))*(h-36)+18; const yS=v=>(1-(v-0)/(100-0||1))*(h-36)+18;
  ctx.strokeStyle='#f3f4f6'; ctx.lineWidth=1; for(let i=0;i<5;i++){const yy=(i/4)*(h-36)+18; ctx.beginPath(); ctx.moveTo(40,yy); ctx.lineTo(w-12,yy); ctx.stroke();}
  const y60=yF(f0); ctx.beginPath(); ctx.moveTo(40,y60); ctx.lineTo(w-12,y60); ctx.setLineDash([]); ctx.strokeStyle='#9ca3af'; ctx.lineWidth=1; ctx.stroke();
  ctx.fillStyle='#6b7280'; ctx.font=`${10*DPR}px sans-serif`; ctx.fillText('60 Hz', 44, y60-4);
  const xsF=xs; drawSeries(ctx,w,h,xsF,fVals.map(yF),COLORS.freq);
  drawSeries(ctx,w,h,xsF,sVals.map(yS),'#009E73',true);
  const last=series[series.length-1]; const df = last.f - st.f0;
  E.live.textContent=`t=${(last.t/3600).toFixed(2)} h | f=${last.f.toFixed(3)} Hz | Δf=${(df>=0?'+':'')}${df.toFixed(3)} Hz | PV=${last.Ppv.toFixed(2)} MW | Wind=${last.Pwind.toFixed(2)} MW | Diesel=${last.Pdg.toFixed(2)} MW | BESS=${last.Pb.toFixed(2)} MW | SOC=${last.soc.toFixed(1)}% | Load=${last.Pload.toFixed(2)} MW`;
  ctx.fillStyle='#374151'; ctx.font=`${11*DPR}px sans-serif`; const ticks=Math.max(3,Math.round(Hwin));
  for(let k=0;k<=ticks;k++){const tk=t0+(k/ticks)*(t1-t0),x=40+(k/ticks)*(w-60);ctx.fillText(`${(tk/3600).toFixed(1)}h`,x-14,h-6);}
  if(seg.length>2){
    const fmaxSeg=Math.max(...seg.map(d=>d.f));
    const fminSeg=Math.min(...seg.map(d=>d.f));
    const pbMax=Math.max(...seg.map(d=>Math.abs(d.Pb)));
    E.kpiWin.textContent=`窗口 f∈[${fminSeg.toFixed(2)}, ${fmaxSeg.toFixed(2)}] Hz · |BESS|_max=${pbMax.toFixed(2)} MW`;
  }
}

/* ────────── KPI / 循环 ────────── */
function refreshKPI(){
  E.kpiFuel.textContent=fmt(st.fuelL,"L");
  E.kpiFuelBase.textContent=fmt(st.fuelBaselineL,"L");
  const saved = Math.max(0, st.fuelBaselineL - st.fuelL);
  E.kpiFuelSave.textContent=fmt(saved,"L");
  const E_RE=st.pvDir+st.windDir; E.kpiRE.textContent=fmt(st.E_load>0?100*E_RE/st.E_load:0,"%");
  E.kpiCurt.textContent=fmt(st.curtWh,"MWh");
  E.kpiN1.textContent=st.n1_ok?"OK":"Not Met";
  E.kpiPVgen.textContent=fmt(st.pv.genWh,"MWh");
  E.kpiWDgen.textContent=fmt(st.wind.genWh,"MWh");
}
function loop(){ if(!running) return; step(); plotPower(); plotFreq(); refreshKPI(); requestAnimationFrame(loop); }

/* ────────── 交互 ────────── */
E.startBtn.onclick=()=>{ if(!running){ if(series.length===0) initState(); running=true; requestAnimationFrame(loop);} };
E.pauseBtn.onclick=()=>{ running=false; };
E.resetBtn.onclick=()=>{ running=false; initState(); plotPower(); plotFreq(); refreshKPI(); };
function onViewChange(){ updateViewLabel(); plotPower(); plotFreq(); }
E.viewHours.addEventListener('input', onViewChange);
E.viewStart.addEventListener('input', ()=>{ E.followLive.checked=false; onViewChange(); });
E.followLive.addEventListener('change', onViewChange);
window.addEventListener('resize', ()=>{ plotPower(); plotFreq(); });

/* ────────── 启动 ────────── */
initState(); plotPower(); plotFreq(); refreshKPI();

})();
</script>
</body>
</html>
